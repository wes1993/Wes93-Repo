name: Sync Jeedom Docker Version

on:
  schedule:
    - cron: "0 */6 * * *"   # ogni 6 ore
  workflow_dispatch:

jobs:
  sync-jeedom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest Docker tag
        id: docker
        run: |
          echo "Fetching latest Jeedom Docker tag..."
          TAG=$(curl -s "https://registry.hub.docker.com/v2/repositories/jeedom/jeedom/tags?page_size=100" \
            | jq -r '.results | sort_by(.last_updated) | last(.[]).name')

          if [ -z "$TAG" ]; then
            echo "❌ No Docker tag found"
            exit 1
          fi

          echo "Latest Docker tag: $TAG"
          echo "version=$TAG" >> $GITHUB_OUTPUT

      - name: Get supported architectures from Docker manifest
        id: arch
        run: |
          TAG="${{ steps.docker.outputs.version }}"
          echo "Fetching manifest for tag $TAG..."
          MANIFEST=$(curl -s -H "Accept: application/vnd.docker.distribution.manifest.list.v2+json" \
            "https://registry.hub.docker.com/v2/jeedom/jeedom/manifests/$TAG")
          
          ARCHS=$(echo "$MANIFEST" | jq -r '.manifests[].platform.architecture' | sort -u)
          
          # Mapping Docker arch -> HA arch
          HA_ARCH=""
          for a in $ARCHS; do
            case $a in
              amd64) HA_ARCH+="amd64 " ;;
              arm64) HA_ARCH+="aarch64 " ;;
              arm) HA_ARCH+="armv7 " ;;
              armhf) HA_ARCH+="armhf " ;;
              i386) HA_ARCH+="i386 " ;;
            esac
          done
          
          HA_ARCH=$(echo $HA_ARCH | xargs)  # trim
          echo "HA architectures: $HA_ARCH"
          echo "arch=$HA_ARCH" >> $GITHUB_OUTPUT

      - name: Update config.yaml
        run: |
          FILE="Jeedom-HA/config.yaml"
          VERSION="${{ steps.docker.outputs.version }}"
          ARCHS="${{ steps.arch.outputs.arch }}"

          CURRENT_VERSION=$(yq e '.version' "$FILE")
          CURRENT_ARCH=$(yq e '.arch | join(" ")' "$FILE")

          if [ "$CURRENT_VERSION" != "$VERSION" ] || [ "$CURRENT_ARCH" != "$ARCHS" ]; then
            echo "Updating config.yaml: version $CURRENT_VERSION → $VERSION, arch $CURRENT_ARCH → $ARCHS"
            yq e -i ".version = \"$VERSION\" | .arch = [\"$(echo $ARCHS | sed 's/ /\", \"/g')\"]" "$FILE"
          else
            echo "No changes required"
            exit 0
          fi

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add Jeedom-HA/config.yaml
          git commit -m "chore(jeedom): bump to ${{ steps.docker.outputs.version }}" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/wes1993/Wes93-Repo.git HEAD:main
